#!/bin/bash
# Mars CLI - Launch mars.app with working directory support
# Usage: mars [path]
#   path: Directory to open (defaults to current directory)

set -e

# Resolve the directory containing this script
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Find mars.app - check relative to script first, then common locations
find_mars_app() {
    local candidates=(
        "$SCRIPT_DIR/../build/mars.app"
        "$SCRIPT_DIR/../../build/mars.app"
        "/Applications/Mars.app"
        "/Applications/mars.app"
        "$HOME/Applications/Mars.app"
        "$HOME/Applications/mars.app"
    )
    
    for app in "${candidates[@]}"; do
        if [ -d "$app" ]; then
            echo "$app"
            return 0
        fi
    done
    
    return 1
}

MARS_APP="$(find_mars_app)" || {
    echo "Error: mars.app not found" >&2
    echo "Searched in:" >&2
    echo "  - $SCRIPT_DIR/../build/mars.app" >&2
    echo "  - /Applications/Mars.app" >&2
    echo "  - $HOME/Applications/Mars.app" >&2
    exit 1
}

# Resolve working directory to absolute path
if [ -n "$1" ]; then
    # User provided a path argument
    if [ -d "$1" ]; then
        WORKDIR="$(cd "$1" && pwd)"
    elif [ -f "$1" ]; then
        # If it's a file, use its parent directory
        WORKDIR="$(cd "$(dirname "$1")" && pwd)"
    else
        echo "Error: '$1' is not a valid path" >&2
        exit 1
    fi
else
    # No argument - use current directory
    WORKDIR="$(pwd)"
fi

echo "Opening Mars in: $WORKDIR"

# Export environment variables that the app will inherit
export MARS_WORKDIR="$WORKDIR"

# Start opencode serve in the working directory FIRST
# Find a random free port
get_free_port() {
    python3 -c 'import socket; s=socket.socket(); s.bind(("", 0)); print(s.getsockname()[1]); s.close()'
}

MARS_PORT=$(get_free_port)
export MARS_PORT="$MARS_PORT"
echo "Using port: $MARS_PORT"

# Kill any existing opencode server on THIS port (unlikely, but good practice)
if lsof -ti:$MARS_PORT > /dev/null 2>&1; then
    echo "Killing existing process on port $MARS_PORT..."
    lsof -ti:$MARS_PORT | xargs kill -9 2>/dev/null || true
    sleep 0.5
fi

echo "Starting opencode server in $WORKDIR..."
cd "$WORKDIR"
nohup opencode serve -p "$MARS_PORT" > /tmp/opencode_server_${MARS_PORT}.log 2>&1 &
OPENCODE_PID=$!
echo "OpenCode server started (PID: $OPENCODE_PID)"

# Wait for server to be ready (max 10 seconds)
echo "Waiting for server to be ready..."
for i in {1..20}; do
    if curl -s http://127.0.0.1:$MARS_PORT/config > /dev/null 2>&1; then
        echo "OpenCode server is ready!"
        break
    fi
    sleep 0.5
done

# Find the actual executable inside the .app bundle
MARS_EXECUTABLE="$MARS_APP/Contents/MacOS/mars"

if [ ! -x "$MARS_EXECUTABLE" ]; then
    echo "Error: Could not find mars executable at $MARS_EXECUTABLE" >&2
    exit 1
fi

# Launch the executable DIRECTLY (not via `open`) so it inherits our environment
# This ensures PATH, MARS_WORKDIR, etc. are available to the app
# Run in background and detach from terminal
nohup "$MARS_EXECUTABLE" "$WORKDIR" > /dev/null 2>&1 &

echo "Mars launched (PID: $!)"
